name: Reconcile arm64 image to Release

on:
  push:
    paths:
      - "requests/*.json"
  workflow_dispatch:

jobs:
  reconcile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read request
        id: req
        run: |
          FILE=$(ls requests/*.json | head -n1)

          IMAGE=$(jq -r '.image' $FILE)
          TAG=$(jq -r '.tag' $FILE)
          PLATFORM=$(jq -r '.platform' $FILE)

          if [ "$PLATFORM" = "aarch64" ]; then
            PLATFORM="linux/arm64"
          fi

          RELEASE="${IMAGE}-${TAG}-arm64"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: release_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "${{ steps.req.outputs.release }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve arm64 digest
        if: steps.release_check.outputs.exists == 'false'
        id: digest
        run: |
          REF="${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }}"

          docker manifest inspect "$REF" > manifest.json

          DIGEST=$(jq -r --arg p "${{ steps.req.outputs.platform }}" '
            .manifests[]
            | select(.platform.os + "/" + .platform.architecture == $p)
            | .digest
          ' manifest.json)

          if [ -z "$DIGEST" ] || [ "$DIGEST" = "null" ]; then
            echo "arm64 not found"
            exit 1
          fi

          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Pull arm64 image
        if: steps.release_check.outputs.exists == 'false'
        run: |
          docker pull "${{ steps.req.outputs.image }}@${{ steps.digest.outputs.digest }}"
          docker tag \
            "${{ steps.req.outputs.image }}@${{ steps.digest.outputs.digest }}" \
            "${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }}"

      - name: Pack image
        if: steps.release_check.outputs.exists == 'false'
        run: |
          docker save "${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }}" \
            | zstd -19 -o image-arm64.tar.zst

      - name: Create release
        if: steps.release_check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create \
            "${{ steps.req.outputs.release }}" \
            image-arm64.tar.zst \
            --title "${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }} (arm64)" \
            --notes "Auto-fetched arm64 image"
