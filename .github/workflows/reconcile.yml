name: Reconcile arm64 image to GitHub Release (GHCR)

on:
  push:
    paths:
      - "requests/*.json"
  workflow_dispatch:

jobs:
  reconcile:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # нужно для Releases
      packages: read   # для pull GHCR
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read request
        id: req
        run: |
          FILE=$(ls requests/*.json | head -n1)

          IMAGE=$(jq -r '.image' $FILE)
          TAG=$(jq -r '.tag' $FILE)
          PLATFORM=$(jq -r '.platform' $FILE)

          # aarch64 → linux/arm64
          if [ "$PLATFORM" = "aarch64" ]; then
            PLATFORM="linux/arm64"
          fi

          RELEASE="${IMAGE}-${TAG}-arm64"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: release_check
        run: |
          if gh release view "${{ steps.req.outputs.release }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        if: steps.release_check.outputs.exists == 'false'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve arm64 digest on GHCR
        if: steps.release_check.outputs.exists == 'false'
        id: digest
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/${{ steps.req.outputs.image }}"
          TAG="${{ steps.req.outputs.tag }}"
          PLATFORM="${{ steps.req.outputs.platform }}"
          REF="${IMAGE}:${TAG}"

          docker manifest inspect "$REF" > manifest.json

          DIGEST=$(jq -r --arg p "$PLATFORM" '
            .manifests[]
            | select(.platform.os + "/" + .platform.architecture == $p)
            | .digest
          ' manifest.json)

          if [ -z "$DIGEST" ] || [ "$DIGEST" = "null" ]; then
            echo "arm64 not found"
            exit 1
          fi

          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Pull arm64 image by digest
        if: steps.release_check.outputs.exists == 'false'
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/${{ steps.req.outputs.image }}"
          TAG="${{ steps.req.outputs.tag }}"
          REF="${IMAGE}@${{ steps.digest.outputs.digest }}"

          docker pull "$REF"
          docker tag "$REF" "${IMAGE}:${TAG}"

      - name: Pack image for release
        if: steps.release_check.outputs.exists == 'false'
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/${{ steps.req.outputs.image }}"
          TAG="${{ steps.req.outputs.tag }}"

          docker save "${IMAGE}:${TAG}" | zstd -19 -o image-arm64.tar.zst

      - name: Create GitHub Release
        if: steps.release_check.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.req.outputs.release }}" \
            image-arm64.tar.zst \
            --title "${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }} (arm64)" \
            --notes "Auto-fetched arm64 image from GHCR"
