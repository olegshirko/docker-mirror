name: Reconcile arm64 image to Release

on:
  push:
    paths:
      - "requests/*.json"
  workflow_dispatch:

jobs:
  reconcile:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # для Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read request
        id: req
        run: |
          FILE=$(ls requests/*.json | head -n1)
          IMAGE=$(jq -r '.image' $FILE)
          TAG=$(jq -r '.tag' $FILE)
          PLATFORM=$(jq -r '.platform' $FILE)

          if [ "$PLATFORM" = "aarch64" ]; then
            PLATFORM="linux/arm64"
          fi

          RELEASE="${IMAGE}-${TAG}-arm64"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: release_check
        run: |
          if gh release view "${{ steps.req.outputs.release }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.release_check.outputs.exists == 'false'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull arm64 image
        if: steps.release_check.outputs.exists == 'false'
        run: |
          IMAGE="${{ steps.req.outputs.image }}"
          TAG="${{ steps.req.outputs.tag }}"
          PLATFORM="${{ steps.req.outputs.platform }}"

          # pull arm64 directly
          docker pull --platform $PLATFORM "$IMAGE:$TAG"

          # get digest of pulled image
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE:$TAG" | cut -d@ -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Pack image into tar.zst
        if: steps.release_check.outputs.exists == 'false'
        run: |
          IMAGE="${{ steps.req.outputs.image }}"
          TAG="${{ steps.req.outputs.tag }}"
          docker save "$IMAGE:$TAG" | zstd -19 -o image-arm64.tar.zst

      - name: Create GitHub Release
        if: steps.release_check.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.req.outputs.release }}" \
            image-arm64.tar.zst \
            --title "${{ steps.req.outputs.image }}:${{ steps.req.outputs.tag }} (arm64)" \
            --notes "Auto-fetched arm64 image from Docker Hub"
